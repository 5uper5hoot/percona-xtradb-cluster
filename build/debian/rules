#!/usr/bin/make -f

#export DH_VERBOSE=1

include /usr/share/dpatch/dpatch.make

CMAKE=cmake
TMP=$(CURDIR)/debian/tmp/

feature_set="community"
compilation_comment_release="Percona XtraDB Cluster (GPL)"
server_suffix="-55"
prefix="/usr"

clean: clean-patched unpatch

clean-patched:
	dh clean
	rm -rf CMakeFiles

build: patch
	echo "Building Percona XtraDB Cluster 22.1"
	dh_testdir
	$(CMAKE) . -DBUILD_CONFIG=mysql_release \
	   -DINSTALL_LAYOUT=DEB \
           -DCMAKE_BUILD_TYPE=RelWithDebInfo \
           -DWITH_EMBEDDED_SERVER=OFF \
           -DMYSQL_UNIX_ADDR="/var/run/mysqld/mysqld.sock" \
           -DFEATURE_SET=$(feature_set) \
           -DCOMPILATION_COMMENT=$(compilation_comment_release) \
           -DWITH_INNODB_DISALLOW_WRITES=ON \
           -DWITH_WSREP=ON \
           -DMYSQL_SERVER_SUFFIX=$(server_suffix)
	make $(MAKE_JFLAG)
	
	dh_auto_test

binary:
	echo "Making binary"
	dh --before dh_installinit binary
	dh_installinit --name=mysql
	dh --after dh_installinit binary


binary-arch:
	echo "Making binary"
	dh --before dh_installinit binary-arch
	dh_installinit --name=mysql
	dh --after dh_installinit binary-arch

binary-indep:
	echo "Making binary"
	dh --before dh_installinit binary-indep
	dh_installinit --name=mysql
	dh --after dh_installinit binary-indep

install:
	echo "Making binary"
	dh --before dh_installinit install
	dh_installinit --name=mysql
	dh --after dh_installinit install
