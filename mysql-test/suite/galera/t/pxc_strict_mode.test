
#
# Test different options with different variation of pxc-strict-mode.
#

--source include/galera_cluster.inc
--source include/have_innodb.inc


#-------------------------------------------------------------------------------
#
# create test-bed
#
# let's cache the default value first.
--connection node_1
--echo #node-1
--let $pxc_strict_mode_saved1 = `SELECT @@pxc_strict_mode`
--let restartdir= $MYSQLTEST_VARDIR/tmp/restartdir
--mkdir $restartdir

--connection node_1
--echo #node-1
--let $pxc_strict_mode_saved2 = `SELECT @@pxc_strict_mode`

# to allow insertion in add_suppression table.
set global pxc_strict_mode='DISABLED';

call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster doesn't recommends use of MyISAM table replication as it is an experimental feature");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster doesn't recommend use of DML on table .* created with non-transactional storage engine");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster doesn't recommend use of TRUNCATE on table created with non-transactional storage engine");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster doesn't recommend use of ADMIN command on table created with non-transactional storage engine");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster doesn't recommend use of ALTER on table created with non-transactional storage engine");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster prohibits use of DML on table .* created with non-transactional storage engine");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster prohibits use of TRUNCATE on table created with non-transactional storage engine");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster prohibits use of ADMIN command on table created with non-transactional storage engine");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster prohibits use of ALTER on table created with non-transactional storage engine");

call mtr.add_suppression("WSREP: Can't change strict-mode with wsrep_replicate_myisam turned ON");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster prohibits use of MyISAM table replication as it is an experimental feature");

call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster recommends setting binlog_format to ROW");
call mtr.add_suppression("WSREP: Can't change strict-mode while binlog format != ROW");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster prohibits setting binlog_format to");

call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster doesn't recommend use of DML on table .* without an explicit primary key");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster prohibits use of DML on table .* without an explicit primary key");

call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster recommends setting log_output to FILE");
call mtr.add_suppression("WSREP: Can't change strict-mode while log_output != NONE/FILE");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster prohibits setting log_output to TABLE");

call mtr.add_suppression("WSREP: Can't change strict-mode while isolation level is SERIALIZABLE");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster doesn't recommend use of LOCK TABLE/FLUSH TABLE <table> WITH READ LOCK");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster doesn't recommend use of GET_LOCK/RELEASE_LOCK");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster doesn't recommend using SERIALIZABLE isolation mode with multi-node workload");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster prohibits use of LOCK TABLE/FLUSH TABLE <table> WITH READ LOCK");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster prohibits use of GET_LOCK/RELEASE_LOCK");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster prohibits using SERIALIZABLE isolation mode");

call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster doesn't recommend use of CREATE TABLE AS SELECT");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster prohibits use of CREATE TABLE AS SELECT");

--connection node_2
--echo #node-2

# to allow insertion in add_suppression table.
set global pxc_strict_mode='DISABLED';

call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster doesn't recommends use of MyISAM table replication as it is an experimental feature");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster doesn't recommend use of DML on table");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster doesn't recommend use of TRUNCATE on table created with non-transactional storage engine");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster doesn't recommend use of ADMIN command on table created with non-transactional storage engine");
call mtr.add_suppression("WSREP: Percona-XtraDB-Cluster doesn't recommend use of ALTER on table created with non-transactional storage engine");

#-------------------------------------------------------------------------------
#
# Scenario-1: Engine-type
# (supported engine-type are transactional engines like InnoDB)
#

#----------------------------
#
# DISABLED
--connection node_1
--echo #node-1
set global pxc_strict_mode = 'DISABLED';
select @@pxc_strict_mode;

#
# base table in myisam format
--connection node_1
--echo #node-1
create table tmyisam (i int, primary key pk(i)) engine=myisam;
set session wsrep_replicate_myisam=1;
insert into tmyisam values (1), (2);
set session wsrep_replicate_myisam=0;
select * from tmyisam;
#
--connection node_2
--echo #node-2
--echo #2 rows expected as pxc-strict-mode = DISABLED and wsrep_replicate_myisam=1
select * from tmyisam;
#
--connection node_1
--echo #node-1
truncate table tmyisam;
select * from tmyisam;
check table tmyisam;
repair table tmyisam;
optimize table tmyisam;
analyze table tmyisam;
alter table tmyisam add column j int;
alter table tmyisam engine=myisam;
alter table tmyisam engine=memory;
alter table tmyisam engine=innodb;
drop table tmyisam;

#
# base table in memory format
--connection node_1
--echo #node-1
create table tmem (i int, primary key pk(i)) engine=memory;
insert into tmem values (1), (2);
select * from tmem;
#
--connection node_2
--echo #node-2
--echo #0 rows expected as pxc doesn't replicate any other tables besides InnoDB and MyISAM
select * from tmem;
#
--connection node_1
--echo #node-1
truncate table tmem;
select * from tmem;
select * from tmem;
check table tmem;
repair table tmem;
optimize table tmem;
analyze table tmem;
alter table tmem add column j int;
alter table tmem engine=myisam;
alter table tmem engine=memory;
alter table tmem engine=innodb;
drop table tmem;


#
# base table in innodb format
--connection node_1
--echo #node-1
create table tinnodb (i int, primary key pk(i)) engine=innodb;
insert into tinnodb values (1), (2);
select * from tinnodb;
#
--connection node_2
--echo #node-2
--echo #2 rows expected with engine=innodb
select * from tinnodb;
#
--connection node_1
--echo #node-1
truncate table tinnodb;
select * from tinnodb;
check table tinnodb;
repair table tinnodb;
optimize table tinnodb;
analyze table tinnodb;
alter table tinnodb add column j int;
alter table tinnodb engine=myisam;
alter table tinnodb engine=memory;
alter table tinnodb engine=innodb;
drop table tinnodb;


#----------------------------
#
# PERMISSIVE
--connection node_1
--echo #node-1
set global pxc_strict_mode = 'PERMISSIVE';
select @@pxc_strict_mode;

#
# base table in myisam format
--connection node_1
--echo #node-1
create table tmyisam (i int, primary key pk(i)) engine=myisam;
set session wsrep_replicate_myisam=1;
insert into tmyisam values (1), (2);
set session wsrep_replicate_myisam=0;
select * from tmyisam;
#
--connection node_2
--echo #node-2
--echo #2 rows expected as pxc-strict-mode = DISABLED and wsrep_replicate_myisam=1
select * from tmyisam;
#
--connection node_1
--echo #node-1
truncate table tmyisam;
select * from tmyisam;
check table tmyisam;
repair table tmyisam;
optimize table tmyisam;
analyze table tmyisam;
alter table tmyisam add column j int;
alter table tmyisam engine=myisam;
alter table tmyisam engine=memory;
alter table tmyisam engine=innodb;
drop table tmyisam;

#
# base table in memory format
--connection node_1
--echo #node-1
create table tmem (i int, primary key pk(i)) engine=memory;
insert into tmem values (1), (2);
select * from tmem;
#
--connection node_2
--echo #node-2
--echo #0 rows expected as pxc doesn't replicate any other tables besides InnoDB and MyISAM
select * from tmem;
#
--connection node_1
--echo #node-1
truncate table tmem;
select * from tmem;
check table tmem;
repair table tmem;
optimize table tmem;
analyze table tmem;
alter table tmem add column j int;
alter table tmem engine=memory;
alter table tmem engine=myisam;
alter table tmem engine=innodb;
drop table tmem;


#
# base table in innodb format
--connection node_1
--echo #node-1
create table tinnodb (i int, primary key pk(i)) engine=innodb;
insert into tinnodb values (1), (2);
select * from tinnodb;
#
--connection node_2
--echo #node-2
--echo #2 rows expected with engine=innodb
select * from tinnodb;
#
--connection node_1
--echo #node-1
truncate table tinnodb;
select * from tinnodb;
check table tinnodb;
repair table tinnodb;
optimize table tinnodb;
analyze table tinnodb;
alter table tinnodb add column j int;
alter table tinnodb engine=myisam;
alter table tinnodb engine=memory;
alter table tinnodb engine=innodb;
drop table tinnodb;


#----------------------------
#
# ENFORCING
--connection node_1
--echo #node-1
set global pxc_strict_mode = 'ENFORCING';
select @@pxc_strict_mode;

#
# base table in myisam format
--connection node_1
--echo #node-1
create table tmyisam (i int, primary key pk(i)) engine=myisam;
# write is blocked as myisam is non-transactional storage engine not supported by PXC.
--error ER_UNKNOWN_ERROR
insert into tmyisam values (1), (2);
select * from tmyisam;
#
--connection node_2
--echo #node-2
--echo #0 rows expected as write is blocked.
select * from tmyisam;
#
--connection node_1
--echo #node-1
# ADMIN and ALTER commands are blocked too except changing engine to InnoDB 
--error ER_UNKNOWN_ERROR
truncate table tmyisam;
select * from tmyisam;
--error ER_UNKNOWN_ERROR
check table tmyisam;
--error ER_UNKNOWN_ERROR
repair table tmyisam;
--error ER_UNKNOWN_ERROR
optimize table tmyisam;
--error ER_UNKNOWN_ERROR
analyze table tmyisam;
--error ER_UNKNOWN_ERROR
alter table tmyisam add column j int;
alter table tmyisam engine=myisam;
--error ER_UNKNOWN_ERROR
alter table tmyisam engine=memory;
alter table tmyisam engine=innodb;
drop table tmyisam;

#
# base table in memory format
--connection node_1
--echo #node-1
create table tmem (i int, primary key pk(i)) engine=memory;
# write is blocked as memory is non-transactional storage engine not supported by PXC.
--error ER_UNKNOWN_ERROR
insert into tmem values (1), (2);
select * from tmem;
#
--connection node_2
--echo #node-2
--echo #0 rows expected as write is blocked.
select * from tmem;
#
--connection node_1
--echo #node-1
# ADMIN and ALTER commands are blocked too except changing engine to InnoDB 
--error ER_UNKNOWN_ERROR
truncate table tmem;
select * from tmem;
--error ER_UNKNOWN_ERROR
check table tmem;
--error ER_UNKNOWN_ERROR
repair table tmem;
--error ER_UNKNOWN_ERROR
optimize table tmem;
--error ER_UNKNOWN_ERROR
analyze table tmem;
--error ER_UNKNOWN_ERROR
alter table tmem add column j int;
alter table tmem engine=memory;
--error ER_UNKNOWN_ERROR
alter table tmem engine=myisam;
alter table tmem engine=innodb;
drop table tmem;


#
# base table in innodb format
--connection node_1
--echo #node-1
create table tinnodb (i int, primary key pk(i)) engine=innodb;
insert into tinnodb values (1), (2);
select * from tinnodb;
#
--connection node_2
--echo #node-2
select * from tinnodb;
#
--connection node_1
--echo #node-1
truncate table tinnodb;
select * from tinnodb;
check table tinnodb;
repair table tinnodb;
optimize table tinnodb;
analyze table tinnodb;
alter table tinnodb add column j int;
# switching from transactional to non-transactional is blocked.
--error ER_UNKNOWN_ERROR
alter table tinnodb engine=myisam;
--error ER_UNKNOWN_ERROR
alter table tinnodb engine=memory;
alter table tinnodb engine=innodb;
drop table tinnodb;

#-------------------------------------------------------------------------------
#
# Scenario-2: Test effect of pxc-strict-mode on wsrep_replicate_myisam
#

#----------------------------
#
# DISABLED
--connection node_1
--echo #node-1
set global pxc_strict_mode = 'DISABLED';
select @@pxc_strict_mode;

#
# wsrep_replicate_myisam = 0
--connection node_1
--echo #node-1
set session wsrep_replicate_myisam = 0;
select @@wsrep_replicate_myisam;
create table tmyisam (i int, primary key pk(i)) engine=myisam;
insert into tmyisam values (1), (2);
select * from tmyisam;
#
--connection node_2
--echo #node-2
--echo #0 rows expected as myisam replication is off.
select * from tmyisam;
drop table tmyisam;

#
# wsrep_replicate_myisam = 1
--connection node_1
--echo #node-1
set session wsrep_replicate_myisam = 1;
select @@wsrep_replicate_myisam;
create table tmyisam (i int, primary key pk(i)) engine=myisam;
insert into tmyisam values (1), (2);
select * from tmyisam;
#
--connection node_2
--echo #node-2
--echo #2 rows expected as myisam replication is on.
select * from tmyisam;
drop table tmyisam;

#----------------------------
#
# PERMISSIVE
--connection node_1
--echo #node-1
set global pxc_strict_mode = 'PERMISSIVE';
select @@pxc_strict_mode;

#
# wsrep_replicate_myisam = 0
--connection node_1
--echo #node-1
set session wsrep_replicate_myisam = 0;
select @@wsrep_replicate_myisam;
create table tmyisam (i int, primary key pk(i)) engine=myisam;
insert into tmyisam values (1), (2);
select * from tmyisam;
#
--connection node_2
--echo #node-2
--echo #0 rows expected as myisam replication is off.
select * from tmyisam;
drop table tmyisam;

#
# wsrep_replicate_myisam = 1
--connection node_1
--echo #node-1
set session wsrep_replicate_myisam = 1;
select @@wsrep_replicate_myisam;
create table tmyisam (i int, primary key pk(i)) engine=myisam;
insert into tmyisam values (1), (2);
select * from tmyisam;
#
--connection node_2
--echo #node-2
--echo #2 rows expected as myisam replication is on.
select * from tmyisam;
drop table tmyisam;

#----------------------------
#
# ENFORCING
--connection node_1
--echo #node-1
--error ER_WRONG_VALUE_FOR_VAR
set global pxc_strict_mode = 'ENFORCING';
set session wsrep_replicate_myisam = 0;
set global pxc_strict_mode = 'ENFORCING';
select @@pxc_strict_mode;

#
# wsrep_replicate_myisam = 0
--connection node_1
--echo #node-1
set session wsrep_replicate_myisam = 0;
select @@wsrep_replicate_myisam;
create table tmyisam (i int, primary key pk(i)) engine=myisam;
# trick insertion to myisam as enforcing will block insertion to myisam table.
set global pxc_strict_mode = 'DISABLED';
insert into tmyisam values (1), (2);
set global pxc_strict_mode = 'ENFORCING';
select * from tmyisam;
#
--connection node_2
--echo #node-2
--echo #0 rows expected as myisam replication is off.
select * from tmyisam;
drop table tmyisam;

#
# wsrep_replicate_myisam = 1
--connection node_1
--echo #node-1
--error ER_WRONG_VALUE_FOR_VAR
set session wsrep_replicate_myisam = 1;
select @@wsrep_replicate_myisam;
create table tmyisam (i int, primary key pk(i)) engine=myisam;
# trick insertion to myisam as enforcing will block insertion to myisam table.
set global pxc_strict_mode = 'DISABLED';
insert into tmyisam values (1), (2);
set global pxc_strict_mode = 'ENFORCING';
select * from tmyisam;
--connection node_2
--echo #node-2
--echo #0 rows expected as myisam replication is on.
select * from tmyisam;
drop table tmyisam;

#
# restart option
--echo # restart with wsrep_replicate_myisam=1
--error 1
--exec $MYSQLD --no-defaults --wsrep_provider="libgalera_smm.so" --wsrep_replicate_myisam=1 > $restartdir/restart.log 2>&1
--echo "grep --count \"WSREP: Percona-XtraDB-Cluster prohibits use of MyISAM table replication as it is an experimental feature\""
--exec grep --count "WSREP: Percona-XtraDB-Cluster prohibits use of MyISAM table replication as it is an experimental feature" $restartdir/restart.log
--remove_file $restartdir/restart.log

#-------------------------------------------------------------------------------
#
# Scenario-3: Test effect of pxc-strict-mode on binlog_format
#

#----------------------------
#
# DISABLED
--connection node_1
--echo #node-1
set global pxc_strict_mode = 'DISABLED';
select @@pxc_strict_mode;

#
# binlog_format=STATEMENT
--connection node_1
--echo #node-1
set session binlog_format = 'STATEMENT';
select @@binlog_format;
create table tinnodb (i int, primary key pk(i)) engine=innodb;
insert into tinnodb values (1), (2);
select * from tinnodb;
#
--connection node_2
--echo #node-2
--echo #2 rows expected as as pxc-strict-mode = DISABLED
select * from tinnodb;
drop table tinnodb;

#
# binlog_format=MIXED
--connection node_1
--echo #node-1
set session binlog_format = 'MIXED';
select @@binlog_format;
create table tinnodb (i int, primary key pk(i)) engine=innodb;
--error ER_LOCK_DEADLOCK
insert into tinnodb values (1), (2);
select * from tinnodb;
#
--connection node_2
--echo #node-2
--echo #0 rows expected as as binlog_format = MIXED
select * from tinnodb;
drop table tinnodb;

#
# binlog_format=ROW
--connection node_1
--echo #node-1
set session binlog_format = 'ROW';
select @@binlog_format;
create table tinnodb (i int, primary key pk(i)) engine=innodb;
insert into tinnodb values (1), (2);
select * from tinnodb;
#
--connection node_2
--echo #node-2
--echo #2 rows expected as as binlog_format = ROW
select * from tinnodb;
drop table tinnodb;

#----------------------------
#
# PERMISSIVE
--connection node_1
--echo #node-1
set global pxc_strict_mode = 'PERMISSIVE';
select @@pxc_strict_mode;

#
# binlog_format=STATEMENT
--connection node_1
--echo #node-1
set session binlog_format = 'STATEMENT';
select @@binlog_format;
create table tinnodb (i int, primary key pk(i)) engine=innodb;
insert into tinnodb values (1), (2);
select * from tinnodb;
#
--connection node_2
--echo #node-2
--echo #2 rows expected as as pxc-strict-mode = DISABLED
select * from tinnodb;
drop table tinnodb;

#
# binlog_format=MIXED
--connection node_1
--echo #node-1
set session binlog_format = 'MIXED';
select @@binlog_format;
create table tinnodb (i int, primary key pk(i)) engine=innodb;
--error ER_LOCK_DEADLOCK
insert into tinnodb values (1), (2);
select * from tinnodb;
#
--connection node_2
--echo #node-2
--echo #0 rows expected as as binlog_format = MIXED
select * from tinnodb;
drop table tinnodb;

#
# binlog_format=ROW
--connection node_1
--echo #node-1
set session binlog_format = 'ROW';
select @@binlog_format;
create table tinnodb (i int, primary key pk(i)) engine=innodb;
insert into tinnodb values (1), (2);
select * from tinnodb;
#
--connection node_2
--echo #node-2
--echo #2 rows expected as as binlog_format = ROW
select * from tinnodb;
drop table tinnodb;

#----------------------------
#
# ENFORCING
--connection node_1
--echo #node-1
set session binlog_format = 'STATEMENT';
--error ER_WRONG_VALUE_FOR_VAR
set global pxc_strict_mode = 'ENFORCING';
set session binlog_format = 'ROW';
set global pxc_strict_mode = 'ENFORCING';
select @@pxc_strict_mode;

#
# binlog_format=STATEMENT
--connection node_1
--echo #node-1
--error ER_WRONG_VALUE_FOR_VAR
set session binlog_format = 'STATEMENT';
select @@binlog_format;
--error ER_WRONG_VALUE_FOR_VAR
set session binlog_format = 'MIXED';
select @@binlog_format;

#
# binlog_format=ROW
--connection node_1
--echo #node-1
set session binlog_format = 'ROW';
select @@binlog_format;
create table tinnodb (i int, primary key pk(i)) engine=innodb;
insert into tinnodb values (1), (2);
select * from tinnodb;
#
--connection node_2
--echo #node-2
--echo #2 rows expected as as binlog_format = ROW
select * from tinnodb;
drop table tinnodb;

#
# restart option
--echo # restart with binlog_format=STATEMENT
--error 1
--exec $MYSQLD --no-defaults --wsrep_provider="libgalera_smm.so" --binlog_format=STATEMENT > $restartdir/restart.log 2>&1
--echo "grep --count \"WSREP: Percona-XtraDB-Cluster prohibits setting binlog_format to STATEMENT/MIXED (anything other than ROW)\""
--exec grep --count "WSREP: Percona-XtraDB-Cluster prohibits setting binlog_format to STATEMENT/MIXED (anything other than ROW)" $restartdir/restart.log
--remove_file $restartdir/restart.log

#-------------------------------------------------------------------------------
#
# Scenario-4: Test effect of pxc-strict-mode on table without explicit primary key
#

#----------------------------
#
# DISABLED
--connection node_1
--echo #node-1
set global pxc_strict_mode = 'DISABLED';
select @@pxc_strict_mode;

#
--connection node_1
--echo #node-1
create table tinnodb (i int) engine=innodb;
create table tmyisam (i int) engine=innodb;
insert into tinnodb values (1), (2);
insert into tmyisam values (1), (2);
select * from tinnodb;
select * from tmyisam;
drop table tmyisam;
#
--connection node_2
--echo #node-2
--echo #2 rows expected as pxc-strict-mode = DISABLED
select * from tinnodb;
drop table tinnodb;

#----------------------------
#
# PERMISSIVE
--connection node_1
--echo #node-1
set global pxc_strict_mode = 'PERMISSIVE';
select @@pxc_strict_mode;

#
--connection node_1
--echo #node-1
create table tinnodb (i int) engine=innodb;
create table tmyisam (i int) engine=innodb;
insert into tinnodb values (1), (2);
insert into tmyisam values (1), (2);
select * from tinnodb;
select * from tmyisam;
drop table tmyisam;
#
--connection node_2
--echo #node-2
--echo #2 rows expected as pxc-strict-mode = PERMISSIVE 
select * from tinnodb;
drop table tinnodb;

#----------------------------
#
# ENFORCING
--connection node_1
--echo #node-1
set global pxc_strict_mode = 'ENFORCING';
select @@pxc_strict_mode;

#
--connection node_1
--echo #node-1
create table tinnodb (i int) engine=innodb;
create table tmyisam (i int) engine=innodb;
--error ER_UNKNOWN_ERROR
insert into tinnodb values (1), (2);
--error ER_UNKNOWN_ERROR
insert into tmyisam values (1), (2);
drop table tmyisam;
#
--connection node_2
--echo #node-2
--echo #0 rows expected as pxc-strict-mode = ENFORCING and table is without primary key 
select * from tinnodb;
drop table tinnodb;

#-------------------------------------------------------------------------------
#
# Scenario-5: Test effect of pxc-strict-mode on log_output
#
--connection node_1
--echo #node-1
--let $general_log_saved = `SELECT @@general_log`
set global general_log = 1;
--let $general_log_file_saved = `SELECT @@general_log_file`
set global log_output = 'NONE';
--eval set global general_log_file = `$restartdir/pxc.strict.mode.log`;

#----------------------------
#
# DISABLED
--connection node_1
--echo #node-1
set global pxc_strict_mode = 'DISABLED';
select @@pxc_strict_mode;

#
# log_output=NONE
--connection node_1
--echo #node-1
set global log_output = 'NONE';
select 1 from dual;

#
# log_output=FILE
--connection node_1
--echo #node-1
set global log_output = 'FILE';
select 1 from dual;
--sleep 1
--echo # grep --count "select 1 from dual"
--exec grep --count "select 1 from dual" $restartdir/pxc.strict.mode.log

#
# log_output=TABLE
--connection node_1
--echo #node-1
select count(*) from mysql.general_log;
set global log_output = 'TABLE';
select 1 from dual;
select count(*) from mysql.general_log;

#----------------------------
#
# PERMISSIVE
--connection node_1
--echo #node-1
set global pxc_strict_mode = 'PERMISSIVE';
select @@pxc_strict_mode;

#
# log_output=NONE
--connection node_1
--echo #node-1
set global log_output = 'NONE';
select 1 from dual;

#
# log_output=FILE
--connection node_1
--echo #node-1
set global log_output = 'FILE';
select 1 from dual;
--sleep 1
--echo # grep --count "select 1 from dual"
--exec grep --count "select 1 from dual" $restartdir/pxc.strict.mode.log

#
# log_output=TABLE
--connection node_1
--echo #node-1
select count(*) from mysql.general_log;
set global log_output = 'TABLE';
select 1 from dual;
select count(*) from mysql.general_log;

#----------------------------
#
# ENFORCING
--connection node_1
--echo #node-1
--error ER_WRONG_VALUE_FOR_VAR
set global pxc_strict_mode = 'ENFORCING';
set global log_output = 'FILE';
set global pxc_strict_mode = 'ENFORCING';
select @@pxc_strict_mode;

#
# log_output=NONE
--connection node_1
--echo #node-1
set global log_output = 'NONE';
select 1 from dual;

#
# log_output=FILE
--connection node_1
--echo #node-1
set global log_output = 'FILE';
select 1 from dual;
--sleep 1
--echo # grep --count "select 1 from dual"
--exec grep --count "select 1 from dual" $restartdir/pxc.strict.mode.log

#
# log_output=TABLE
--connection node_1
--echo #node-1
select count(*) from mysql.general_log;
--error ER_WRONG_VALUE_FOR_VAR
set global log_output = 'TABLE';
select 1 from dual;
select count(*) from mysql.general_log;

#
# restart option
--echo # restart with log_output=TABLE
--error 1
--exec $MYSQLD --no-defaults --wsrep_provider="libgalera_smm.so" --log_output=TABLE > $restartdir/restart.log 2>&1
--echo "grep --count \"WSREP: Percona-XtraDB-Cluster prohibits setting log_output to TABLE (anything other than FILE/NONE)\""
--exec grep --count "WSREP: Percona-XtraDB-Cluster prohibits setting log_output to TABLE (anything other than FILE/NONE)" $restartdir/restart.log
--remove_file $restartdir/restart.log

--disable_query_log
--eval set global general_log = $general_log_saved;
--eval set global general_log_file = `$general_log_file_saved`;
--remove_file $restartdir/pxc.strict.mode.log
--enable_query_log

#-------------------------------------------------------------------------------
#
# Scenario-6: Test effect of pxc-strict-mode on different kind of lock statement
#
--connection node_1
--echo #node-1

--let $tx_isolation_saved = `SELECT @@session.tx_isolation`

#----------------------------
#
# DISABLED
--connection node_1
--echo #node-1
set global pxc_strict_mode = 'DISABLED';
select @@pxc_strict_mode;

#
# Try to issue different kind of locking statements
--connection node_1
--echo #node-1
create table tinnodb (i int, primary key pk(i)) engine=innodb;
insert into tinnodb values (1), (2);
select * from tinnodb;
#
# they will work in disabled mode.
lock table tinnodb read;
unlock tables;
lock table tinnodb write;
unlock tables;
select get_lock('a', 10);
select release_lock('a');
flush table tinnodb with read lock;
unlock tables;
set session transaction isolation level serializable;
#
# they should continue to work ir-respective of mode.
flush table with read lock;
unlock tables;
select i from tinnodb for update;
drop table tinnodb;

#----------------------------
#
# MASTER
--connection node_1
--echo #node-1
--error ER_WRONG_VALUE_FOR_VAR
set global pxc_strict_mode = 'MASTER';
set session transaction isolation level repeatable read;
set global pxc_strict_mode = 'MASTER';
select @@pxc_strict_mode;

#
# Try to issue different kind of locking statements
--connection node_1
--echo #node-1
create table tinnodb (i int, primary key pk(i)) engine=innodb;
insert into tinnodb values (1), (2);
select * from tinnodb;
#
# they will work in master mode.
lock table tinnodb read;
unlock tables;
lock table tinnodb write;
unlock tables;
select get_lock('a', 10);
select release_lock('a');
flush table tinnodb with read lock;
unlock tables;
set session transaction isolation level serializable;
#
# they should continue to work ir-respective of mode.
flush table with read lock;
unlock tables;
select i from tinnodb for update;
drop table tinnodb;

#----------------------------
#
# PERMISSIVE
--connection node_1
--echo #node-1
set global pxc_strict_mode = 'PERMISSIVE';
select @@pxc_strict_mode;

#
# Try to issue different kind of locking statements
--connection node_1
--echo #node-1
create table tinnodb (i int, primary key pk(i)) engine=innodb;
insert into tinnodb values (1), (2);
select * from tinnodb;
#
# they will work in permissive mode.
lock table tinnodb read;
unlock tables;
lock table tinnodb write;
unlock tables;
select get_lock('a', 10);
select release_lock('a');
flush table tinnodb with read lock;
unlock tables;
set session transaction isolation level serializable;
#
# they should continue to work ir-respective of mode.
flush table with read lock;
unlock tables;
select i from tinnodb for update;
drop table tinnodb;

#----------------------------
#
# ENFORCING
--connection node_1
--echo #node-1
--error ER_WRONG_VALUE_FOR_VAR
set global pxc_strict_mode = 'ENFORCING';
set session transaction isolation level repeatable read;
set global pxc_strict_mode = 'ENFORCING';
select @@pxc_strict_mode;

#
# Try to issue different kind of locking statements
--connection node_1
--echo #node-1
create table tinnodb (i int, primary key pk(i)) engine=innodb;
insert into tinnodb values (1), (2);
select * from tinnodb;
#
# they will work in permissive mode.
--error ER_NOT_SUPPORTED_YET
lock table tinnodb read;
unlock tables;
--error ER_NOT_SUPPORTED_YET
lock table tinnodb write;
unlock tables;
--error ER_NOT_SUPPORTED_YET
select get_lock('a', 10);
--error ER_NOT_SUPPORTED_YET
select release_lock('a');
--error ER_NOT_SUPPORTED_YET
flush table tinnodb with read lock;
unlock tables;
--error ER_WRONG_VALUE_FOR_VAR
set session transaction isolation level serializable;
#
# they should continue to work ir-respective of mode.
flush table with read lock;
unlock tables;
select i from tinnodb for update;
drop table tinnodb;

set session transaction isolation level repeatable read;

#-------------------------------------------------------------------------------
#
# Scenario-7: innodb_autoinc_lock_mode=Interleaved/2
#
--echo # restart with innodb_autoinc_lock_mode=2
--error 1
--exec $MYSQLD --no-defaults --wsrep_provider="libgalera_smm.so" --innodb_autoinc_lock_mode=1 > $restartdir/restart.log 2>&1
--echo "grep --count \"WSREP: Percona-XtraDB-Cluster requires innodb_autoinc_lock_mode"
--exec grep --count "WSREP: Percona-XtraDB-Cluster requires innodb_autoinc_lock_mode" $restartdir/restart.log
--remove_file $restartdir/restart.log

#-------------------------------------------------------------------------------
#
# Scenario-8: Test effect of pxc-strict-mode on CTAS
#

#----------------------------
#
# DISABLED
--connection node_1
--echo #node-1
set global pxc_strict_mode = 'DISABLED';
select @@pxc_strict_mode;

#
--connection node_1
--echo #node-1
create table tinnodb (i int, primary key pk(i)) engine=innodb;
insert into tinnodb values (1), (2);
select * from tinnodb;
create table tinnodb2 (i int, primary key pk(i)) as (select * from tinnodb);
select * from tinnodb2;
#
--connection node_2
--echo #node-2
--echo #2 rows expected with CTAS as pxc_strict_mode = DISABLED
select * from tinnodb2;
drop table tinnodb;
drop table tinnodb2;

#----------------------------
#
# PERMISSIVE
--connection node_1
--echo #node-1
set global pxc_strict_mode = 'PERMISSIVE';
select @@pxc_strict_mode;

#
--connection node_1
--echo #node-1
create table tinnodb (i int, primary key pk(i)) engine=innodb;
insert into tinnodb values (1), (2);
select * from tinnodb;
create table tinnodb2 (i int, primary key pk(i)) as (select * from tinnodb);
select * from tinnodb2;
#
--connection node_2
--echo #node-2
--echo #2 rows expected with CTAS as pxc_strict_mode = PERMISSIVE 
select * from tinnodb2;
drop table tinnodb;
drop table tinnodb2;

#----------------------------
#
# ENFORCING
--connection node_1
--echo #node-1
set global pxc_strict_mode = 'ENFORCING';
select @@pxc_strict_mode;

#
# Try to issue different kind of locking statements
--connection node_1
--echo #node-1
create table tinnodb (i int, primary key pk(i)) engine=innodb;
insert into tinnodb values (1), (2);
select * from tinnodb;
--error ER_UNKNOWN_ERROR
create table tinnodb2 (i int, primary key pk(i)) as (select * from tinnodb);
#
--connection node_2
--echo #node-2
--error ER_NO_SUCH_TABLE 
select * from tinnodb2;
drop table tinnodb;


#-------------------------------------------------------------------------------
#
# remove test-bed
#
--connection node_1
--echo #node-1
--eval set global pxc_strict_mode = $pxc_strict_mode_saved1;
#
--connection node_2
--echo #node-2
--eval set global pxc_strict_mode = $pxc_strict_mode_saved2;
